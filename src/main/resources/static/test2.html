<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Engineary</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --sidebar-width: 250px; }
        body { min-height: 100vh; display: flex; background-color: #f4f7f6; }
        /* サイドバー装飾 */
        .sidebar { 
            width: var(--sidebar-width); 
            background-color: #1a1d20; 
            color: white; 
            position: fixed; 
            height: 100vh;
        }
        .sidebar .nav-link { color: #adb5bd; transition: 0.3s; }
        .sidebar .nav-link:hover, .sidebar .nav-link.active { color: white; background-color: #343a40; }
        /* メインコンテンツ位置調整 */
        .main-content { 
            margin-left: var(--sidebar-width); 
            flex-grow: 1; 
            padding: 40px; 
        }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

    <nav class="sidebar d-flex flex-column p-3">
        <h3 class="p-3">Engineary</h3>
        <hr>
        <ul class="nav nav-pills flex-column mb-auto">
            <li class="nav-item">
                <a href="#" class="nav-link" id="menu-memo">メモ</a>
            </li>
            <li>
                <a href="#" class="nav-link active" id="menu-diary">日誌</a>
            </li>
            <li>
                <a href="#" class="nav-link" id="menu-tag">タグ管理</a>
            </li>
        </ul>
        <hr>
        <div class="px-3 pb-3 small text-muted">User: Guest</div>
    </nav>

    <main class="main-content">
        <section id="diary-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold">日誌一覧</h2>
                <button class="btn btn-primary shadow-sm" data-bs-toggle="modal" data-bs-target="#diaryModal">
                    + 新規作成
                </button>
            </div>

            <div class="card">
                <div class="card-body p-0">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-4">日付</th>
                                <th>タイトル</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="diary-list">
                            <tr>
                                <td colspan="3" class="text-center py-4 text-muted">
                                    データを読み込み中、またはAPI未接続です...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>
<!-- モーダルのサイズを大きくする。 -->
    <div class="modal fade" id="diaryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">日誌を記録する</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="diary-form">
                        <div class="mb-3">
                            <label for="title" class="form-label">タイトル</label>
                            <input type="text" class="form-control" id="diary-title" required>
                        </div>
                        <div class="mb-3">
                            <label for="content" class="form-label">内容</label>
                            <textarea class="form-control" id="diary-content" rows="4" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                    <button type="button" class="btn btn-primary" id="diary-btn-save">保存</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        /*
         * REST API 連携の考え方:
         * 1. ページ読み込み完了時に API(GET) を呼び出し、diary-list を書き換える
         * 2. 「保存」ボタンが押されたら API(POST) を呼び出し、画面をリロードする
         * 3. 「削除」ボタンが押されたら API(DELETE) を呼び出す
         */
        console.log("REST API 連携の準備ができました。");

        //select all
        window.onload = function(){
            loadDiary();
        };

        async function loadDiary(){
            //controllerのgetAllEntriesにアクセス
            const res = await fetch('/diary');
            const entries = await res.json();
            //tbody(diary-list)の取得    
            const listElement = document.getElementById('diary-list');
            //初期化して、取得したentriesを代入
            listElement.innerHTML = '';
            entries.forEach(entry => {
                const row = `
                    <tr>
                        <td>${diary.date}</td>
                        <td>${diary.title}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteDiary(${diary.id})">削除</button>
                        </td>
                    </tr>`;
                listElement.insertAdjacentHTML('beforeend',row);
            })
        }

        //create
        document.addEventListener('DOMContentLoaded', () => {
            // モーダル内の「保存ボタン」を取得する。
            const saveBtn = document.getElementById('diary-btn-save');

            // クリックされた時
            saveBtn.addEventListener('click', async () => {
                // 3. 入力欄から値を取り出す
                const title = document.getElementById('diary-title').value;
                const content = document.getElementById('diary-content').value;

                // JavaのAPI（POST）を呼び出す(詳細を設定，要復習)
                const response = await fetch('/diary', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: title, content: content })
                });

                if (response.ok) {
                    alert('保存しました');
                    // 保存が終わったら画面をリロードして一覧を更新する
                    location.reload();
                } else {
                    alert('保存に失敗しました');
                }
            });
        });//次は画面とapiの通信を試す。

    </script>
</body>
</html>